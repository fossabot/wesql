--source suite/smartengine/include/have_smartengine.inc

--echo #
--echo #  Test how MyX handles reading corrupted data from disk.
--echo #  Data corruption is simulated at source-code level.
--echo #

--source include/have_debug.inc


--echo #
--echo #  A test for case when data in the table *record* is longer
--echo #  than table DDL expects it to be
--echo #
create table t1 (
  pk int not null primary key,
  col1 varchar(10)
) ENGINE = SMARTENGINE charset=latin1 collate=latin1_bin;

insert into t1 values (1,1),(2,2),(3,3);

select * from t1;

#set @tmp1=@@smartengine_verify_row_debug_checksums;
#set smartengine_verify_row_debug_checksums=1;
#set session debug= "+d,myx_simulate_bad_row_read1";
#--error ER_GET_ERRNO
#select * from t1 where pk=1;
#set session debug= "-d,myx_simulate_bad_row_read1";
#set smartengine_verify_row_debug_checksums=@tmp1;

select * from t1 where pk=1;

set session debug= "+d,myx_simulate_bad_row_read2";
--error ER_GET_ERRNO
select * from t1 where pk=1;
set session debug= "-d,myx_simulate_bad_row_read2";

set session debug= "+d,myx_simulate_bad_row_read3";
--error ER_GET_ERRNO
select * from t1 where pk=1;
set session debug= "-d,myx_simulate_bad_row_read3";

insert into t1 values(4,'0123456789');
select * from t1;
drop table t1;

--echo #
--echo #  A test for case when index data is longer than table DDL
--echo #  expects it to be
--echo #

create table t2 (
  pk varchar(4) not null primary key,
  col1 int not null
) ENGINE = SMARTENGINE charset=latin1 collate latin1_bin;

insert into t2 values ('ABCD',1);
select * from t2;
set session debug= "+d,myx_simulate_bad_pk_read1";
--error ER_GET_ERRNO
select * from t2;
set session debug= "-d,myx_simulate_bad_pk_read1";

drop table t2;

create table t2 (
  pk varchar(4) not null primary key,
  col1 int not null
) ENGINE = SMARTENGINE charset=latin1 collate=latin1_bin;

insert into t2 values ('ABCD',1);

select * from t2;
set session debug= "+d,myx_simulate_bad_pk_read1";
--error ER_GET_ERRNO
select * from t2;
set session debug= "-d,myx_simulate_bad_pk_read1";

drop table t2;

# smartengine log has no CURRENT_TEST TAG
# assume all ERROR generated before this test has been processed by previous
# tests, here we can replace ERROR generated by this test
--let $REP = <ERROR_replaced_in_smartengine.corrupted_data_reads_debug>
--source suite/smartengine/include/filter_out_smartengine_log_error.inc

