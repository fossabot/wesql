--source include/have_debug.inc
--source include/have_log_bin.inc
--source include/have_gtid.inc
--source include/have_debug_sync.inc
--source include/paxos.inc
--source include/have_binlog_format_row.inc

--disable_warnings

# crash_commit_before_log ----  before write binlog
# consensus_replication_crash_after_write_cache ---- before flush binlog but follower get binlog
# crash_after_flush_binlog
# crash_commit_after_log
# consensus_replication_crash_after_sync ---- after sync binlog
# consensus_replication_crash_after_commit ---- after commit
# crash_after_update_pos_before_apply -- before do commit in xa prepare
# crash_create_non_critical_before_update_index
# crash_create_critical_before_update_index
# crash_create_after_update_index
# crash_create_before_rename_index_file
# crash_create_after_rename_index_file
# crash_after_flush_engine_log

# crash_during_large_event_binlog_flush
# crash_during_large_event_binlog_flush_slow

# crash_during_large_event_receive
# crash_during_large_event_receive_slow

# crash_before_update_pos -- only dml
# crash_after_commit_and_update_pos -- not imple
# crash_on_transactional_ddl_insert

--echo #
--echo # DDL crash and recovery
--echo #

connection default;
let $master_uuid= `SELECT @@GLOBAL.SERVER_UUID`;
SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
# uncommitted
create table t1(id int);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
show tables;

set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
# uncommitted
create table t2(id int);

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
show tables;

set debug = 'd, consensus_replication_crash_after_sync';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
# uncommitted
create table t3(id int);

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
show tables;

set debug = 'd, consensus_replication_crash_after_commit';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
# committed
create table t4(id int);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_non_critical_before_update_index';
# committed
create table t5(id int);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_critical_before_update_index';
# committed
create table t6(id int);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_after_update_index';
# committed
create table t7(id int);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_before_rename_index_file';
# committed
create table t8(id int);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_after_rename_index_file';
# committed
create table t9(id int);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_after_flush_engine_log';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
# uncommitted
create table t11(id int);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

#---------------------------------------------------------------------------------------
# crash_on_transactional_ddl_insert
# cannot ensure gtid consistency in transactional_ddl
#---------------------------------------------------------------------------------------
# 
# --connect (con2,127.0.0.1,root,,test,$MYPORT_2)
# connection con2;
# SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
# 
# connection default;
# create table t(id int);
# insert into t values(1);
# --source include/wait_follower_catchup.inc
# 
# connection con2;
# SET @@GLOBAL.DEBUG= '+d, crash_on_transactional_ddl_insert';
# --replace_result $master_uuid MASTER_UUID
# SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
# --exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
# 
# connection default;
# # committed
# CREATE TABLE t12 AS SELECT * FROM t;
# 
# connection con2;
# --source include/wait_until_disconnected.inc
# --exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
# --enable_reconnect
# --let $wait_follower= 1
# --source include/wait_until_connected_again.inc
# --let $wait_follower= 0
# --disable_reconnect
# SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
# --replace_result $master_uuid MASTER_UUID
# SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
# --disconnect con2
# 
# connection default;
show tables;
drop table t4,t5,t6,t7,t8,t9;

--echo #
--echo # Normal DML (1000) crash and recovery
--echo #

connection default;
SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
create table t(id int);
--source include/wait_follower_catchup.inc

set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1000);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1001);

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, consensus_replication_crash_after_write_cache';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1002);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, consensus_replication_crash_after_sync';

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1003);

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_after_flush_binlog';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1004);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, consensus_replication_crash_after_commit';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1005);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_non_critical_before_update_index';

insert into t values(1006);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_critical_before_update_index';

insert into t values(1007);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_after_update_index';

insert into t values(1008);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_before_rename_index_file';

insert into t values(1009);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_create_after_rename_index_file';

insert into t values(1010);
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
flush logs;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

set debug = 'd, crash_after_flush_engine_log';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values(1012);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

connection default;
select * from t;
drop table t;

# 
# crash_during_large_event_binlog_flush crash_during_large_event_binlog_flush_slow
# 
connection default;
create table t_large(id int primary key, data longblob);
--source include/wait_follower_catchup.inc
SET @@GLOBAL.DEBUG= '+d,crash_during_large_event_binlog_flush';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t_large values (1, repeat("a", 2048576));

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
SET @@GLOBAL.DEBUG= '+d, crash_during_large_event_binlog_flush_slow';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t_large values (2, repeat("b", 2048576));

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# 
# crash_during_large_event_receive crash_during_large_event_receive_slow
# 
--connect (con2,127.0.0.1,root,,test,$MYPORT_2)
connection con2;
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SET @@GLOBAL.DEBUG= '+d, crash_during_large_event_receive';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect

connection default;
insert into t_large values (3, repeat("c", 2048576));
insert into t_large values (4, repeat("c", 1));

connection con2;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
--enable_reconnect
--let $wait_follower= 1
--source include/wait_until_connected_again.inc
--let $wait_follower= 0
--disable_reconnect
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
--source include/wait_apply_catchup.inc
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

SET @@GLOBAL.DEBUG= '+d,crash_during_large_event_receive_slow';
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect

connection default;
insert into t_large values (5, repeat("d", 2048576));
insert into t_large values (6, repeat("d", 1));

connection con2;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
--enable_reconnect
--let $wait_follower= 1
--source include/wait_until_connected_again.inc
--let $wait_follower= 0
--disable_reconnect
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
--source include/wait_apply_catchup.inc
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

connection default;
select id from t_large;
drop table t_large;

--disconnect con2

--echo #
--echo # Xa Prepare crash and Rollback after recovery(2000)
--echo #

connection default;
create table t(id int);
--source include/wait_follower_catchup.inc
xa begin '2001';
insert into t values (2001);
xa end '2001';

set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '2001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

xa begin '2002';
insert into t values (2002);
xa end '2002';

set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '2002';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

xa begin '2003';
insert into t values (2003);
xa end '2003';

set debug = 'd, consensus_replication_crash_after_sync';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '2003';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

# maybe have bug
xa begin '2004';
insert into t values (2004);
xa end '2004';

set debug = 'd, consensus_replication_crash_after_commit';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '2004';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa rollback '2004';
# end maybe

select * from t;

--echo #
--echo # Xa Prepare crash and Commit after recovery(2000) 
--echo #

connection default;
xa begin '3001';
insert into t values (3001);
xa end '3001';

set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '3001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

xa begin '3002';
insert into t values (3002);
xa end '3002';

set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '3002';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

xa begin '3003';
insert into t values (3003);
xa end '3003';

set debug = 'd, consensus_replication_crash_after_sync';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '3003';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

# below case crashes sometimes, comment it, refer to https://bugs.mysql.com/bug.php?id=110430
xa begin '3004';
insert into t values (3004);
xa end '3004';

set debug = 'd, consensus_replication_crash_after_commit';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '3004';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa commit '3004';

select * from t;


--echo #
--echo # Xa Commit crash and recovery (4000)
--echo #

connection default;
xa begin '4001';
insert into t values (4001);
xa end '4001';
xa prepare '4001';

set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa commit '4001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

set debug = 'd, consensus_replication_crash_after_sync';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa commit '4001';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa commit '4001';

xa begin '4002';
insert into t values (4002);
xa end '4002';
xa prepare '4002';

set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa commit '4002';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa commit '4002';

xa begin '4003';
insert into t values (4003);
xa end '4003';
xa prepare '4003';

set debug = 'd, consensus_replication_crash_after_commit';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa commit '4003';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

select * from t;

--echo #
--echo # Xa Rollback crash and recovery (5000)
--echo #

connection default;
xa begin '5001';
insert into t values (5001);
xa end '5001';
xa prepare '5001';

set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa rollback '5001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

set debug = 'd, consensus_replication_crash_after_sync';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa rollback '5001';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa rollback '5001';

xa begin '5002';
insert into t values (5002);
xa end '5002';
xa prepare '5002';

set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa rollback '5002';

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa rollback '5002';

xa begin '5003';
insert into t values (5003);
xa end '5003';
xa prepare '5003';

set debug = 'd, consensus_replication_crash_after_commit';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa rollback '5003';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;

select * from t;

--echo #
--echo # Crash happened on XA COMMIT ONE PHASE (5500)
--echo #
connection default;
xa begin '5501';
insert into t values (5501);
xa end '5501';
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
XA COMMIT "5501" ONE PHASE;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa begin '5502';
insert into t values (5502);
xa end '5502';
set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
XA COMMIT "5502" ONE PHASE;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

connection default;
xa begin '5503';
insert into t values (5503);
xa end '5503';
set debug = 'd, consensus_replication_crash_after_sync';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
XA COMMIT "5503" ONE PHASE;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa begin '5504';
insert into t values (5504);
xa end '5504';
set debug = 'd, consensus_replication_crash_after_commit';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
XA COMMIT "5504" ONE PHASE;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

select * from t;
drop table t;

--echo #
--echo # Xa with binlog And Crash at flush stage (6000)
--echo #

connection default;
drop table if exists t1;
drop table if exists t2;
drop table if exists t3;
create table t1(id int);
create table t2(id int);
--source include/wait_follower_catchup.inc

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

# crash_commit_before_log
connection con101;
xa begin '6001';
insert into t1 values (6001);
xa end '6001';
SET DEBUG_SYNC= 'bgc_after_enrolling_for_flush_stage SIGNAL prepare_6001_ready WAIT_FOR no_signal';
send xa prepare '6001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR prepare_6001_ready";
--replace_column 1 #
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t2;

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
--disable_reconnect

xa recover;
xa begin '6001';
insert into t1 values (6001);
xa end '6001';
xa prepare '6001';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
SET DEBUG_SYNC= 'bgc_after_enrolling_for_flush_stage SIGNAL commit_6001_ready WAIT_FOR no_signal';
send xa commit '6001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR commit_6001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t2;

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa commit '6001';

show tables;
--disconnect con101
--disconnect con102

--echo #
--echo # Xa And DML Crash after flush stage before sync stage (7000)
--echo #

# crash_commit_before_log and commit
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '7001';
insert into t1 values (7001);
xa end '7001';
SET DEBUG_SYNC= 'bgc_after_flush_stage_before_sync_stage SIGNAL prepare_7001_ready WAIT_FOR no_signal';
send xa prepare '7001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR prepare_7001_ready";
--replace_column 1 #
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t2;

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa begin '7001';
insert into t1 values (7001);
xa end '7001';
xa prepare '7001';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
SET DEBUG_SYNC= 'bgc_after_flush_stage_before_sync_stage SIGNAL commit_7001_ready WAIT_FOR no_signal';
send xa commit '7001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR commit_7001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t2;

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa commit '7001';

--disconnect con101
--disconnect con102

# crash_commit_before_log and rollback
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '7002';
insert into t1 values (7002);
xa end '7002';
xa prepare '7002';

connection con101;
SET DEBUG_SYNC= 'bgc_after_flush_stage_before_sync_stage SIGNAL rollback_7002_ready WAIT_FOR no_signal';
send xa rollback '7002';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR rollback_7002_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t2;

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa rollback '7002';

--disconnect con101
--disconnect con102

--echo #
--echo # Xa And DML Crash at sync stage (8000)
--echo #

# crash_commit_before_log and commit
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '8001';
insert into t1 values (8001);
xa end '8001';
SET DEBUG_SYNC= 'bgc_after_enrolling_for_sync_stage SIGNAL prepare_8001_ready WAIT_FOR no_signal';
send xa prepare '8001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR prepare_8001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (8002);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa begin '8001';
insert into t1 values (8001);
xa end '8001';
xa prepare '8001';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
SET DEBUG_SYNC= 'bgc_after_enrolling_for_sync_stage SIGNAL commit_8001_ready WAIT_FOR no_signal';
send xa commit '8001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR commit_8001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (8003);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa commit '8001';

select * from t1;
show tables;

--disconnect con101
--disconnect con102

# crash_commit_before_log and rollback
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '8002';
insert into t1 values (8004);
xa end '8002';
xa prepare '8002';
SET DEBUG_SYNC= 'bgc_after_enrolling_for_sync_stage SIGNAL rollback_8002_ready WAIT_FOR no_signal';
send xa rollback '8002';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR rollback_8002_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (8005);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa rollback '8002';

select * from t1;

--disconnect con101
--disconnect con102

--echo #
--echo # Xa Crash after sync stage before commit stage (9000)
--echo #

# crash_commit_before_log and commit
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '9001';
insert into t1 values (9001);
xa end '9001';
SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL prepare_9001_ready WAIT_FOR no_signal';
send xa prepare '9001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR prepare_9001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (9002);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

xa recover;
xa begin '9001';
insert into t1 values (9001);
xa end '9001';
xa prepare '9001';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL commit_9001_ready WAIT_FOR no_signal';
send xa commit '9001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR commit_9001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (9003);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa commit '9001';

--disconnect con101
--disconnect con102

# crash_commit_before_log and rollback
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '9002';
insert into t1 values (9004);
xa end '9002';
xa prepare '9002';

SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL rollback_9002_ready WAIT_FOR no_signal';
send xa rollback '9002';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR rollback_9002_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (9005);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa rollback '9002';

--disconnect con101
--disconnect con102

# crash_commit_after_log and commit
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '9003';
insert into t1 values (9006);
xa end '9003';
SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL prepare_9003_ready WAIT_FOR no_signal';
send xa prepare '9003';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR prepare_9003_ready";
set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (9007);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa begin '9003';
insert into t1 values (9006);
xa end '9003';
xa prepare '9003';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL commit_9003_ready WAIT_FOR no_signal';
send xa commit '9003';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR commit_9003_ready";
set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (9008);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa commit '9003';
--disconnect con101
--disconnect con102

# crash_commit_after_log and rollback
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '9004';
insert into t1 values (9009);
xa end '9004';
xa prepare '9004';
SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL rollback_9004_ready WAIT_FOR no_signal';
send xa rollback '9004';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR rollback_9004_ready";
set debug = 'd, crash_commit_after_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (9010);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa rollback '9004';
--disconnect con101
--disconnect con102

--echo #
--echo # Xa Crash at commit stage (10000)
--echo #

# crash_commit_before_log and commit
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '10001';
insert into t1 values (10001);
xa end '10001';
SET DEBUG_SYNC= 'bgc_after_enrolling_for_commit_stage SIGNAL prepare_10001_ready WAIT_FOR no_signal';
send xa prepare '10001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR prepare_10001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (10002);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;

xa recover;
xa begin '10001';
insert into t1 values (10001);
xa end '10001';
xa prepare '10001';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
SET DEBUG_SYNC= 'bgc_after_enrolling_for_commit_stage SIGNAL commit_10001_ready WAIT_FOR no_signal';
send xa commit '10001';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR commit_10001_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (10003);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa commit '10001';

--disconnect con101
--disconnect con102

# crash_commit_before_log and rollback
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
connection con101;
xa begin '10002';
insert into t1 values (10004);
xa end '10002';
xa prepare '10002';
SET DEBUG_SYNC= 'bgc_after_enrolling_for_commit_stage SIGNAL rollback_10002_ready WAIT_FOR no_signal';
send xa rollback '10002';

connection con102;
SET DEBUG_SYNC = "now WAIT_FOR rollback_10002_ready";
set debug = 'd, crash_commit_before_log';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED;

# Write file to make mysql-test-run.pl restart the server
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (10005);

connection con101;
--error 2013
reap;

--source include/wait_leader_change.inc

connection default;
--source include/wait_until_disconnected.inc
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
--replace_result $master_uuid MASTER_UUID
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
xa recover;
xa rollback '10002';

--disconnect con101
--disconnect con102
--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

select * from t1;
drop table t1;
drop table t2;
--source include/wait_follower_catchup.inc
--disconnect con101
--disconnect con102

connection default;
SET @@GLOBAL.DEBUG= '';
--enable_warnings
