--source include/paxos.inc

#change consensus_leader to 3;
--replace_result $PAXOS_PORT_3 PAXOS_PORT_3
eval call dbms_consensus.change_leader("127.0.0.1:$PAXOS_PORT_3");
--connect (conn3,127.0.0.1,root,,mysql,$MYPORT_3)
let $wait_condition= select count(*)=1 from information_schema.wesql_cluster_local where role='leader';
--source include/wait_condition.inc
select server_id, role, instance_type from information_schema.wesql_cluster_local;

#add consensus_learner "127.0.0.1:10001";
call dbms_consensus.add_learner("127.0.0.1:10001");
#drop consensus_learner "127.0.0.1:10001";
call dbms_consensus.drop_learner("127.0.0.1:10001");

--error ER_CONSENSUS_LOG_TYPE_NODE
change master to master_host='127.0.0.1';

--error ER_CONSENSUS_LOG_TYPE_NODE
start consensus_replication;
--error ER_CONSENSUS_LOG_TYPE_NODE
stop consensus_replication;

# test binlog dump
--let $master_binlog= query_get_value(SHOW MASTER STATUS, File, 1)
--let $master_pos= query_get_value(SHOW MASTER STATUS, Position, 1)
--exec $MYSQL_BINLOG --read-from-remote-master=BINLOG-DUMP-NON-GTIDS --user=root --host=127.0.0.1 --port=$MYPORT_3 --start-position=$master_pos $master_binlog | wc -l
--error 1
--exec $MYSQL_BINLOG --read-from-remote-master=BINLOG-DUMP-GTIDS --user=root --host=127.0.0.1 --port=$MYPORT_3 --start-position=$master_pos $master_binlog

#change consensus_leader to 1;
--replace_result $PAXOS_PORT_1 PAXOS_PORT_1
eval call dbms_consensus.change_leader("127.0.0.1:$PAXOS_PORT_1");
--connection default
--enable_reconnect
# wait until catchup and become leader
let $wait_condition= select SERVER_READY_FOR_RW='Yes' from information_schema.wesql_cluster_local where role='leader';
--source include/wait_condition.inc
