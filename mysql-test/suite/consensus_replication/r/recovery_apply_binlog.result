#
# DDL crash and recovery
#
set debug = 'd, crash_commit_before_log';
create table t(id int) engine=innodb;
ERROR HY000: Lost connection to MySQL server during query
show tables;
Tables_in_test
set debug = 'd, consensus_replication_crash_after_commit';
create table t(id int) engine = innodb;
ERROR HY000: Lost connection to MySQL server during query
show tables;
Tables_in_test
t
#
# Normal DML (1000) crash and recovery
#
set debug = 'd, crash_commit_before_log';
insert into t values (1000);
ERROR HY000: Lost connection to MySQL server during query
set debug = 'd, consensus_replication_crash_after_write_cache';
insert into t values (1001);
ERROR HY000: Lost connection to MySQL server during query
set debug = 'd, consensus_replication_crash_after_commit';
insert into t values (1002);
ERROR HY000: Lost connection to MySQL server during query
select * from t;
id
1002
#
# Xa Prepare crash and Rollback after recovery(2000) 
#
xa begin '2001';
insert into t values (2001);
xa end '2001';
set debug = 'd, crash_commit_before_log';
xa prepare '2001';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
xa begin '2002';
insert into t values (2002);
xa end '2002';
set debug = 'd, consensus_replication_crash_after_commit';
xa prepare '2002';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	2002
xa rollback '2002';
select * from t;
id
1002
#
# Xa Prepare crash and Commit after recovery(2000) 
#
xa begin '3001';
insert into t values (3001);
xa end '3001';
set debug = 'd, crash_commit_before_log';
xa prepare '3001';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
xa begin '3002';
insert into t values (3002);
xa end '3002';
set debug = 'd, consensus_replication_crash_after_commit';
xa prepare '3002';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	3002
xa commit '3002';
select * from t;
id
1002
3002
#
# Xa Commit crash and recovery (4000)
#
xa begin '4001';
insert into t values (4001);
xa end '4001';
xa prepare '4001';
set debug = 'd, crash_commit_before_log';
xa commit '4001';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	4001
set debug = 'd, consensus_replication_crash_after_commit';
xa commit '4001';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
select * from t;
id
1002
3002
4001
#
# Xa Rollback crash and recovery (5000)
#
xa begin '5001';
insert into t values (5001);
xa end '5001';
xa prepare '5001';
set debug = 'd, crash_commit_before_log';
xa rollback '5001';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	5001
set debug = 'd, consensus_replication_crash_after_commit';
xa rollback '5001';
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
select * from t;
id
1002
3002
4001
#
# Crash happened on XA COMMIT ONE PHASE (5500)
#
xa begin '5501';
insert into t values (5501);
xa end '5501';
set debug = 'd, crash_commit_before_log';
XA COMMIT "5501" ONE PHASE;
ERROR HY000: Lost connection to MySQL server during query
xa begin '5502';
insert into t values (5502);
xa end '5502';
set debug = 'd, consensus_replication_crash_after_commit';
XA COMMIT "5502" ONE PHASE;
ERROR HY000: Lost connection to MySQL server during query
select * from t;
id
1002
3002
4001
5502
#
# Xa with binlog And DDL Crash (6000)
#
create table t1(id int) engine=innodb;
create table t2(id int) engine=innodb;
create table t3(id int) engine=innodb;
flush logs;
set global binlog_order_commits=OFF;
xa begin '6001';
insert into t1 values (6001);
xa end '6001';
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL prepare_6001_ready WAIT_FOR no_signal';
xa prepare '6001';
xa begin '6002';
insert into t2 values (6002);
xa end '6002';
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL prepare_6002_ready WAIT_FOR no_signal';
xa prepare '6002';
SET DEBUG_SYNC = "now WAIT_FOR prepare_6001_ready";
SET DEBUG_SYNC = "now WAIT_FOR prepare_6002_ready";
set debug = 'd, consensus_replication_crash_after_commit';
drop table t3;
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
create table t3(id int) engine=innodb;
set global binlog_order_commits=OFF;
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	6002
1	4	0	6001
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL commit_6001_ready WAIT_FOR no_signal';
xa commit '6001';
SET DEBUG_SYNC= 'consensus_replication_after_consensus_commit SIGNAL commit_6002_ready WAIT_FOR no_signal';
xa commit '6002';
SET DEBUG_SYNC = "now WAIT_FOR commit_6001_ready";
SET DEBUG_SYNC = "now WAIT_FOR commit_6002_ready";
set debug = 'd, consensus_replication_crash_after_commit';
drop table t3;
ERROR HY000: Lost connection to MySQL server during query
show tables;
Tables_in_test
t
t1
t2
#
# Xa And DML Crash (7000)
#
set global binlog_order_commits=OFF;
xa begin '7001';
insert into t1 values (7001);
xa end '7001';
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL prepare_7001_ready WAIT_FOR no_signal';
xa prepare '7001';
xa begin '7002';
insert into t2 values (7002);
xa end '7002';
SET DEBUG_SYNC= 'consensus_replication_after_consensus_commit SIGNAL prepare_7002_ready WAIT_FOR no_signal';
xa prepare '7002';
SET DEBUG_SYNC = "now WAIT_FOR prepare_7001_ready";
SET DEBUG_SYNC = "now WAIT_FOR prepare_7002_ready";
set debug = 'd, crash_commit_before_log';
insert into t2 values (7004);
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
set global binlog_order_commits=OFF;
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	7002
1	4	0	7001
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL commit_7001_ready WAIT_FOR no_signal';
xa commit '7001';
SET DEBUG_SYNC= 'consensus_replication_after_consensus_commit SIGNAL commit_7002_ready WAIT_FOR no_signal';
xa commit '7002';
SET DEBUG_SYNC = "now WAIT_FOR commit_7001_ready";
SET DEBUG_SYNC = "now WAIT_FOR commit_7002_ready";
set debug = 'd, crash_commit_before_log';
insert into t2 values (7006);
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
select * from t1;
id
6001
7001
select * from t2;
id
6002
7002
#
# Follower apply xa prapare Crash (8000)
#
set global debug = 'd, crash_after_update_pos_before_apply';
stop consensus_replication;
start consensus_replication;
xa begin '8001';
insert into t1 values (8001);
xa end '8001';
xa prepare '8001';
xa recover;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	8001
xa commit '8001';
set global debug = 'd, crash_after_commit_before_update_pos';
stop consensus_replication;
start consensus_replication;
xa begin '8002';
insert into t1 values (8002);
xa end '8002';
xa prepare '8002';
xa recover;
ERROR HY000: Lost connection to MySQL server during query
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	8002
xa commit '8002';
delete from t1;
#
# Follower apply xa commit Crash (9000)
#
xa begin '9001';
insert into t1 values (9001);
xa end '9001';
xa prepare '9001';
set global debug = 'd, crash_commit_before';
xa commit '9001';
select * from t1;
ERROR HY000: Lost connection to MySQL server during query
select * from t1;
id
9001
drop table t, t1, t2;
