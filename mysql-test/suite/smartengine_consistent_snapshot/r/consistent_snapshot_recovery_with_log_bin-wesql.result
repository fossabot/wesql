# Consistent snapshot, change log-bin and consistent snapshot recovey.
# Wait for first snapshots to be generated after startup 
use test;
CREATE TABLE t1(c1 int, c2 char(200)) ENGINE=SMARTENGINE ;
INSERT INTO t1 values(1,'abcd');
SELECT COUNT(*) FROM t1;
COUNT(*)
1
# Wait for all binlog persistent
# Crash
set debug = 'd, crash_commit_before_log';
INSERT INTO t1 values(1,'abcd');
ERROR HY000: Lost connection to MySQL server during query
# Force rmdir datadir for recovery test
# Create an empty data directory...
# 1. Recovery start using consistent snapshot with raft_index = 0
# restart: 
# Wait for first snapshots to be generated after startup recovery.
SELECT COUNT(*) FROM t1;
COUNT(*)
1
INSERT INTO t1 values(2,'abcd');
INSERT INTO t1 values(3,'abcd');
INSERT INTO t1 values(4,'abcd');
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
FLUSH logs;
INSERT INTO t1 values(5,'abcd');
INSERT INTO t1 values(6,'abcd');
INSERT INTO t1 values(7,'abcd');
INSERT INTO t1 values(8,'abcd');
FLUSH logs;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
SELECT count(*) FROM t1;
count(*)
544
# Wait for all binlog persistent
# Crash
set debug = 'd, crash_commit_before_log';
INSERT INTO t1 values(100,'abcd');
ERROR HY000: Lost connection to MySQL server during query
# Force rmdir datadir for recovery test
# Create an empty data directory...
# 2. Recovery start using consistent snapshot
# restart: 
# Wait for snapshots to be generated after startup recovery
SELECT count(*) FROM t1;
count(*)
544
FLUSH Logs;
INSERT INTO t1 values(8,'abcd');
INSERT INTO t1 values(9,'abcd');
INSERT INTO t1 values(10,'abcd');
INSERT INTO t1 SELECT * FROM t1;
SELECT count(*) FROM t1;
count(*)
1094
# Wait for all binlog persistent
# Crash
set debug = 'd, crash_commit_before_log';
INSERT INTO t1 values(100,'abcd');
ERROR HY000: Lost connection to MySQL server during query
# Force rmdir datadir for recovery test
# Create an empty data directory...
# 3. Recovery start using consistent snapshot
# restart
# Wait for snapshots to be generated after startup recovery 
SELECT count(*) FROM t1;
count(*)
1094
DROP TABLE t1;
