--source include/have_wesql_test.inc
--connect (conn1,127.0.0.1,root,,test,$MYPORT_1)
--connect (conn2,127.0.0.1,root,,test,$MYPORT_2)
--connect (conn3,127.0.0.1,root,,test,$MYPORT_3)


--connection conn1
set global consensus_replication_with_cache_log=ON;
use test;
create table t1 (id int);
insert into t1 values (1);

--sleep 2

set global debug="+d,consensus_replication_crash_after_write_cache";
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t1 values (2);
--source include/wait_until_disconnected.inc
--sleep 10

--connection conn1
--let $_expect_file_name= $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/start_mysqld.inc

--sleep 5
insert into t1 values (3);
--source include/wait_follower_catchup.inc

let $cnt1= query_get_value("select count(*) as cnt from t1", cnt, 1);

--connection conn2
--enable_reconnect
let $wait_follower= 1;
--source include/wait_until_connected_again.inc
let $wait_follower= 0;

--source include/wait_apply_catchup.inc

let $cnt2= query_get_value("select count(*) as cnt from t1", cnt, 1);

--connection conn3
--enable_reconnect
let $wait_follower= 1;
--source include/wait_until_connected_again.inc
let $wait_follower= 0;

--source include/wait_apply_catchup.inc

let $cnt3= query_get_value("select count(*) as cnt from t1", cnt, 1);
if ($cnt1 == $cnt2)
{
	if ($cnt2 == $cnt3)
	{
		echo consistent!;
	}
}

--connection conn1
drop table t1;

set global debug="";
