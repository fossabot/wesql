--source include/have_debug.inc
--source include/have_debug_sync.inc

let $MYPORT_CONSENSUS_1 = query_get_value("select $MYPORT_1+8000 as c1", c1, 1);
let $MYPORT_CONSENSUS_2 = query_get_value("select $MYPORT_2+8000 as c1", c1, 1);

#
# testcase: flush logs when leader degrade
#
--connect (conn1,127.0.0.1,root,,test,$MYPORT_1)
--connection conn1
set global debug= '+d,signal_after_downgrade_init_rli,signal_before_downgrade_init_rli';
#change consensus_leader to 1;
--replace_result $MYPORT_CONSENSUS_2 MYPORT_CONSENSUS_2
eval call dbms_consensus.change_leader("127.0.0.1:$MYPORT_CONSENSUS_2");

#degrading and waiting to be signaled
--let $wait_condition= select count(*)=1 from information_schema.wesql_cluster_local where role='Follower'
--source include/wait_condition.inc
--let $sql_running= query_get_value("show slave status", Slave_SQL_Running, 0)
--echo $sql_running

#signal mysql_bin_log to be closed
set debug_sync='before_rotate_consensus_log SIGNAL signal_downgrade_init_rli wait_for after_downgrade_init_rli';
flush logs;

--connection default
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect
set global debug= default;
