--source include/have_debug.inc
--source include/have_log_bin.inc
--source include/have_gtid.inc
--source include/have_debug_sync.inc
--source include/paxos.inc

--disable_warnings

# crash_commit_before_log ----  before write binlog
# consensus_replication_crash_after_write_cache ---- after write cache but before write local file
# consensus_replication_crash_after_commit ---- after consensus replication commit
# crash_after_update_pos_before_apply -- before do commit in xa prepare
# crash_after_commit_before_update_pos -- after do commit in xa prepare

--echo #
--echo # DDL crash and recovery
--echo #

connection default;

set debug = 'd, crash_commit_before_log';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
create table t(id int) engine=innodb;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

show tables;


set debug = 'd, consensus_replication_crash_after_commit';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
create table t(id int) engine = innodb;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

show tables;


--echo #
--echo # Normal DML (1000) crash and recovery
--echo #

connection default;
set debug = 'd, crash_commit_before_log';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1000);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

set debug = 'd, consensus_replication_crash_after_write_cache';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1001);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

set debug = 'd, consensus_replication_crash_after_commit';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t values (1002);

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

select * from t;

--echo #
--echo # Xa Prepare crash and Rollback after recovery(2000) 
--echo #

connection default;
xa begin '2001';
insert into t values (2001);
xa end '2001';

set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '2001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

xa begin '2002';
insert into t values (2002);
xa end '2002';

set debug = 'd, consensus_replication_crash_after_commit';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '2002';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;
xa rollback '2002';

select * from t;


--echo #
--echo # Xa Prepare crash and Commit after recovery(2000) 
--echo #

connection default;
xa begin '3001';
insert into t values (3001);
xa end '3001';

set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '3001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

xa begin '3002';
insert into t values (3002);
xa end '3002';

set debug = 'd, consensus_replication_crash_after_commit';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa prepare '3002';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;
xa commit '3002';

select * from t;


--echo #
--echo # Xa Commit crash and recovery (4000)
--echo #

connection default;
xa begin '4001';
insert into t values (4001);
xa end '4001';
xa prepare '4001';

set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa commit '4001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

set debug = 'd, consensus_replication_crash_after_commit';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa commit '4001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

select * from t;

--echo #
--echo # Xa Rollback crash and recovery (5000)
--echo #

connection default;
xa begin '5001';
insert into t values (5001);
xa end '5001';
xa prepare '5001';

set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa rollback '5001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

set debug = 'd, consensus_replication_crash_after_commit';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
xa rollback '5001';

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

select * from t;

--echo #
--echo # Crash happened on XA COMMIT ONE PHASE (5500)
--echo #
connection default;
xa begin '5501';
insert into t values (5501);
xa end '5501';
set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
XA COMMIT "5501" ONE PHASE;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

connection default;
xa begin '5502';
insert into t values (5502);
xa end '5502';
set debug = 'd, consensus_replication_crash_after_commit';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
XA COMMIT "5502" ONE PHASE;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

select * from t;

--echo #
--echo # Xa with binlog And DDL Crash (6000)
--echo #

connection default;
create table t1(id int) engine=innodb;
create table t2(id int) engine=innodb;
create table t3(id int) engine=innodb;
flush logs;

set global binlog_order_commits=OFF;

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
--connect (con103,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
xa begin '6001';
insert into t1 values (6001);
xa end '6001';
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL prepare_6001_ready WAIT_FOR no_signal';
send xa prepare '6001';

connection con102;
xa begin '6002';
insert into t2 values (6002);
xa end '6002';
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL prepare_6002_ready WAIT_FOR no_signal';
send xa prepare '6002';

connection con103;
SET DEBUG_SYNC = "now WAIT_FOR prepare_6001_ready";
SET DEBUG_SYNC = "now WAIT_FOR prepare_6002_ready";
--replace_column 1 #
set debug = 'd, consensus_replication_crash_after_commit';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t3;

connection con101;
--error 2013
reap;

connection con102;
--error 2013
reap;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
create table t3(id int) engine=innodb;
--disable_reconnect

set global binlog_order_commits=OFF;

xa recover;

--disconnect con101
--disconnect con102
--disconnect con103

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
--connect (con103,127.0.0.1,root,,test,$MYPORT_1)


connection con101;
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL commit_6001_ready WAIT_FOR no_signal';
send xa commit '6001';

connection con102;
SET DEBUG_SYNC= 'consensus_replication_after_consensus_commit SIGNAL commit_6002_ready WAIT_FOR no_signal';
send xa commit '6002';

connection con103;
SET DEBUG_SYNC = "now WAIT_FOR commit_6001_ready";
SET DEBUG_SYNC = "now WAIT_FOR commit_6002_ready";
set debug = 'd, consensus_replication_crash_after_commit';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
drop table t3;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

show tables;

--disconnect con101
--disconnect con102
--disconnect con103

--echo #
--echo # Xa And DML Crash (7000)
--echo #

set global binlog_order_commits=OFF;

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
--connect (con103,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
xa begin '7001';
insert into t1 values (7001);
xa end '7001';
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL prepare_7001_ready WAIT_FOR no_signal';
send xa prepare '7001';

connection con102;
xa begin '7002';
insert into t2 values (7002);
xa end '7002';
SET DEBUG_SYNC= 'consensus_replication_after_consensus_commit SIGNAL prepare_7002_ready WAIT_FOR no_signal';
send xa prepare '7002';

connection con103;
SET DEBUG_SYNC = "now WAIT_FOR prepare_7001_ready";
SET DEBUG_SYNC = "now WAIT_FOR prepare_7002_ready";
set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t2 values (7004);

connection con101;
--error 2013
reap;

connection con102;
--error 2013
reap;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

set global binlog_order_commits=OFF;

xa recover;

--disconnect con101
--disconnect con102
--disconnect con103

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)
--connect (con103,127.0.0.1,root,,test,$MYPORT_1)

connection con101;
SET DEBUG_SYNC= 'consensus_replication_after_sync SIGNAL commit_7001_ready WAIT_FOR no_signal';
send xa commit '7001';

connection con102;
SET DEBUG_SYNC= 'consensus_replication_after_consensus_commit SIGNAL commit_7002_ready WAIT_FOR no_signal';
send xa commit '7002';

connection con103;
SET DEBUG_SYNC = "now WAIT_FOR commit_7001_ready";
SET DEBUG_SYNC = "now WAIT_FOR commit_7002_ready";
set debug = 'd, crash_commit_before_log';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
insert into t2 values (7006);

connection con101;
--error 2013
reap;

connection con102;
--error 2013
reap;

connection default;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

xa recover;

select * from t1;
select * from t2;

--disconnect con101
--disconnect con102
--disconnect con103

--echo #
--echo # Follower apply xa prapare Crash (8000)
--echo #

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

--connect (con2,127.0.0.1,root,,test,$MYPORT_2)


connection con2;
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
set global debug = 'd, crash_after_update_pos_before_apply';
stop consensus_replication;
start consensus_replication;
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect


connection con101;
xa begin '8001';
insert into t1 values (8001);
xa end '8001';
xa prepare '8001';

connection con102;
--source include/wait_follower_catchup.inc

connection con2;
--error 2013
xa recover;

--enable_reconnect
let $wait_follower= 1;
--source include/wait_until_connected_again.inc
let $wait_follower= 0;
--disable_reconnect

xa recover;

connection con101;
xa commit '8001';

connection con2;
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
set global debug = 'd, crash_after_commit_before_update_pos';
stop consensus_replication;
start consensus_replication;
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect

connection con101;
xa begin '8002';
insert into t1 values (8002);
xa end '8002';
xa prepare '8002';

connection con102;
--source include/wait_follower_catchup.inc

connection con2;
--error 2013
xa recover;

--enable_reconnect
let $wait_follower= 1;
--source include/wait_until_connected_again.inc
let $wait_follower= 0;
--disable_reconnect
xa recover;

connection con101;
xa commit '8002';
delete from t1;


--disconnect con101
--disconnect con102
--disconnect con2

--echo #
--echo # Follower apply xa commit Crash (9000)
--echo #

--connect (con101,127.0.0.1,root,,test,$MYPORT_1)
--connect (con102,127.0.0.1,root,,test,$MYPORT_1)

--connect (con2,127.0.0.1,root,,test,$MYPORT_2)

connection con101;
xa begin '9001';
insert into t1 values (9001);
xa end '9001';
xa prepare '9001';
--source include/wait_follower_catchup.inc

connection con2;
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
set global debug = 'd, crash_commit_before';

connection con101;
xa commit '9001';

# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect

connection con102;
--source include/wait_follower_catchup.inc

connection con2;
--error 2013
select * from t1;

--enable_reconnect
let $wait_follower= 1;
--source include/wait_until_connected_again.inc
let $wait_follower= 0;
--disable_reconnect

--source include/wait_apply_catchup.inc
select * from t1;

# connection con101;
# xa begin '9002';
# insert into t1 values (9002);
# xa end '9002';
# xa prepare '9002';

# connection con2;
# --let $auxiliary_connection = con2
# --let $statement_connection = con101
# --let $statement = xa commit '9002'
# --let $sync_point = before_commit_xa_trx
# --source include/execute_to_conditional_timestamp_sync_point.inc
# --source include/kill_mysqld.inc
# --exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect

# connection con102;
# --source include/wait_follower_catchup.inc

# connection con2;
# --error 2013
# select * from t1;

# --enable_reconnect
# let $wait_follower= 1;
# --source include/wait_until_connected_again.inc
# let $wait_follower= 0;
# --disable_reconnect

# --source include/wait_apply_catchup.inc
# select * from t1;

--disconnect con101
--disconnect con102
--disconnect con2


connection default;
drop table t, t1, t2;
--enable_warnings
