SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
set debug = 'd, set_commit_parent_100';
CREATE TABLE t1 (a int primary key) engine=innodb;
CREATE TABLE t2 (a int primary key) engine=innodb;
CREATE TABLE t3 (a int primary key) engine=innodb;
CREATE TABLE t4 (a int primary key) engine=innodb;
STOP SLAVE SQL_THREAD for channel 'consensus_replication_applier';
SET @@GLOBAL.DEBUG= '+d, crash_in_a_worker';
set debug = 'd, set_commit_parent_150';
INSERT INTO t1 values (0);
BEGIN;
INSERT INTO t2 values (1),(2),(3);
UPDATE t2 SET a= a+1 WHERE a=3;
COMMIT;
BEGIN;
INSERT INTO t3 values (1),(2),(3);
UPDATE t3 SET a= a+1 WHERE a=3;
COMMIT;
BEGIN;
INSERT INTO t4 values (1),(2),(3);
UPDATE t4 SET a= a+1 WHERE a=3;
COMMIT;
BEGIN;
INSERT INTO t1 values (1),(2),(3);
UPDATE t1 SET a= a+1 WHERE a=3;
COMMIT;
BEGIN;
select * from t1 where a=4;
a
select * from t2 where a=4;
a
select * from t3 where a=4;
a
select * from t4 where a=4;
a
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-5	
START SLAVE SQL_THREAD for channel 'consensus_replication_applier';
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-10	
select * from t1;
a
0
1
2
4
select * from t2;
a
1
2
4
select * from t3;
a
1
2
4
select * from t4;
a
1
2
4
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-10	
set debug='';
DROP TABLES t1,t2,t3,t4;
create table t(id int) engine=innodb;
SET @@GLOBAL.DEBUG= 'd,crash_after_commit_before_update_pos';
insert into t values(1001);
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-13	
SET @@GLOBAL.DEBUG= '+d,crash_after_commit_before_update_pos';
xa begin '1002';
insert into t values(1002);
xa end '1002';
xa prepare '1002';
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-13	
xa commit '1002';
SET @@GLOBAL.DEBUG= '+d,crash_before_update_pos';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-15	
insert into t values(1016);
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
select * from t;
id
1001
1002
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-15	
set @@GLOBAL.DEBUG= '+d,crash_after_apply';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-15	
insert into t values(1003);
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-16	
select * from t;
id
1001
1002
1016
SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
create table t1(id int) engine=innodb;
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SET @@GLOBAL.DEBUG= '+d, crash_after_update_pos_before_apply';
stop consensus_replication;
start consensus_replication;
SET @@GLOBAL.DEBUG= 'd, disable_gtid_background_persister';
xa begin '1004';
insert into t1 values (1004);
xa end '1004';
xa prepare '1004';
xa recover;
ERROR HY000: Lost connection to MySQL server during query
SET @@GLOBAL.DEBUG= 'd, disable_se_persists_gtid';
SELECT @@GLOBAL.GTID_EXECUTED, @@GLOBAL.GTID_OWNED;
@@GLOBAL.GTID_EXECUTED	@@GLOBAL.GTID_OWNED
MASTER_UUID:1-19	
xa recover;
formatID	gtrid_length	bqual_length	data
1	4	0	1004
select * from t1;
id
xa commit '1004';
drop table t1;
DROP TABLES t;
SET @@GLOBAL.DEBUG= '';
