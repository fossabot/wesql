#
# Test for consistent snapshot recovery from object store
#

# 1. install mysql_clone plugin
--replace_result $CLONE_PLUGIN CLONE_PLUGIN
--eval INSTALL PLUGIN clone SONAME '$CLONE_PLUGIN'

# 2. create run directory

# 3. start with consistent-snapshot-archive
--echo # Server restart with --consistent-snapshot-archive=true
--let $restart_parameters=restart: --smartengine=1 --default-storage-engine=smartengine --default-tmp-storage_engine=innodb --serverless=true --consistent_snapshot_archive_period=1
--source include/restart_mysqld.inc

CREATE DATABASE db1;
CREATE TABLE t1(c1 int) ENGINE=SMARTENGINE ;
INSERT INTO t1 values(1);
INSERT INTO t1 values(2);
INSERT INTO t1 values(3);
INSERT INTO t1 values(4);
SELECT * FROM t1;
SHOW CREATE TABLE t1;

--let $MYSQLD_DATADIR=`select @@datadir`
--let $region = `select @@objstore_region`

# 4. shutdown server and rmdir datadir
--echo # Shutdown server
--source include/shutdown_mysqld.inc

--echo # Force rmdir datadir for recovery test
--let $BACKUP_DATADIR = $MYSQL_TMP_DIR/$region
--force-cpdir $MYSQLD_DATADIR/$region $BACKUP_DATADIR
--force-rmdir $MYSQLD_DATADIR
--echo # Create an empty data directory...
--mkdir $MYSQLD_DATADIR
--force-cpdir $BACKUP_DATADIR $MYSQLD_DATADIR/$region

# 5. recovery
--echo # Recovery start from object store.
--let $restart_parameters=restart: --smartengine=1 --recovery_from_objstore=true --default-storage-engine=smartengine --default-tmp-storage_engine=innodb --serverless=true --consistent_snapshot_archive_period=1
--source include/start_mysqld.inc

SELECT * FROM t1;
DROP DATABASE db1;
