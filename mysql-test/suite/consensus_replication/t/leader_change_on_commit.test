--source include/have_debug.inc
--source include/have_log_bin.inc
--source include/have_gtid.inc
--source include/have_debug_sync.inc
--source include/paxos.inc
--source include/have_binlog_format_row.inc

--disable_warnings

create table t1(id int);

--connect (con1,127.0.0.1,root,,test,$MYPORT_1)
SET DEBUG_SYNC= 'bgc_after_sync_stage_before_commit_stage SIGNAL 6001_flush WAIT_FOR 6001_commit';
begin;
insert into t1 values(6000);
insert into t1 values(6001);
send commit;

--connection default
SET DEBUG_SYNC = "now WAIT_FOR 6001_flush";

--connect (con2,127.0.0.1,root,,test,$MYPORT_2)
--source include/stop_mysqld.inc
--connect (con3,127.0.0.1,root,,test,$MYPORT_3)
--source include/stop_mysqld.inc

--connection default
SET DEBUG_SYNC= 'now SIGNAL 6001_commit';

--connection con1
--error 7500
reap;

--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.2.expect
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.3.expect

--connection con1
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect
select * from t1;

--disconnect con1
--disconnect con2
--disconnect con3

# cleanup
connection default;
drop table t1;
--enable_warnings
