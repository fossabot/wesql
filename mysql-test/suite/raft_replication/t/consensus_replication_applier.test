--disable_warnings

--connect (conn1,127.0.0.1,root,,test,$MYPORT_1)
--connect (conn2,127.0.0.1,root,,test,$MYPORT_2)

--connection conn1
stop slave;
change master to master_host = '127.0.0.1', master_port = 7806, master_user = 'repl', master_password = '123456' for channel 'aaa';
start slave for channel 'aaa';
stop slave;
start slave;
stop slave for channel "aaa";
start slave for channel "aaa";
--error ER_REPLICA_CHANNEL_OPERATION_NOT_ALLOWED
stop raft_replication;
--error ER_REPLICA_CHANNEL_OPERATION_NOT_ALLOWED
start raft_replication;
stop slave;
reset slave all for channel 'aaa';
--connection conn2
stop raft_replication;
reset slave;
# --replace_column 1 # 2 # 3 #
# show consensus logs;
start raft_replication;

--error ER_REPLICA_CHANNEL_OPERATION_NOT_ALLOWED
start slave for channel 'raft_replication_applier';
--error ER_REPLICA_CHANNEL_OPERATION_NOT_ALLOWED
stop slave for channel 'raft_replication_applier';

--let $sql_running= query_get_value("show slave status", Slave_SQL_Running, 1)
--echo $sql_running
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running

--enable_warnings


--connection conn1
--error ER_CHANGE_RPL_INFO_REPOSITORY_FAILURE
set global relay_log_info_repository='file';
set global relay_log_info_repository='table';
select count(1) from mysql.slave_relay_log_info where number_of_workers = (select count(1) from mysql.slave_worker_info);

--connection conn2
--error ER_CHANGE_RPL_INFO_REPOSITORY_FAILURE
set global relay_log_info_repository='file';
stop raft_replication;
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
start raft_replication;
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
select count(1) from mysql.slave_relay_log_info where number_of_workers = (select count(1) from mysql.slave_worker_info);

stop slave sql_thread for channel 'raft_replication_applier';
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
start slave sql_thread for channel 'raft_replication_applier';
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
select count(1) from mysql.slave_relay_log_info where number_of_workers = (select count(1) from mysql.slave_worker_info);

start slave sql_thread for channel 'raft_replication_applier';
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
stop slave sql_thread for channel 'raft_replication_applier';
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
start slave sql_thread for channel 'raft_replication_applier';
--let $sql_running= query_get_value("show slave status for channel 'raft_replication_applier'", Slave_SQL_Running, 1)
--echo $sql_running
select count(1) from mysql.slave_relay_log_info where number_of_workers = (select count(1) from mysql.slave_worker_info);

