name: CICD-PULL-REQUEST

on:
  pull_request:

env:
  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  enable-runner:
    uses: wesql/wesql-cd/.github/workflows/enable-gke-runner.yml@main
    with:
      GITHUB_REPO: "${{ github.repository }}"
      RUNNER_LABEL: "gke-oracle8-amd-runner"
    secrets: inherit

  build-test:
    needs: [ enable-runner ]
    name: make install mtr
    runs-on: [self-hosted, gke-oracle8-amd-runner ]
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
        with:
          all_but_latest: true
          access_token: ${{ env.GITHUB_TOKEN }}

      - uses: actions/checkout@v3
      - name: cmake
        run: |
          sudo yum install -y perl-core
          sudo perl -MCPAN -e 'install IO::Pty'
          sudo perl -MCPAN -e 'install IO::Tty'
          sudo cpan Expect
          cp /home/mysql/boost_1_77_0.tar.bz2 ${{ github.workspace }}/extra
          sudo mkdir -pv /u01
          sudo chown -R mysql:mysql /u01
          sudo chown -R mysql:mysql ./
          sudo yum install python3-devel python3-pip mysql-devel
          sudo pip3 install mysqlclient
          sudo ln -sfn /usr/bin/python3 /usr/bin/python
          mkdir -pv bu
          cd bu
          cmake3 ../ -B ./ \
            -DCMAKE_INSTALL_PREFIX="/u01/mysql" \
            -DWITH_SSL="system" \
            -DCMAKE_BUILD_TYPE="Debug" \
            -DWITH_WESQL_TEST=1   \
            -DWITH_CLONE=1 \
            -DDOWNLOAD_BOOST=1 \
            -DWITH_BOOST="../extra/"

      - name: make install
        run: |
          cd bu
          make -j$(echo "$(nproc)") && make install

      - name: run mtr on serverless
        run: |
          cd bu
          cd mysql-test
          CUR_DIR=`pwd`
          ./mysql-test-run.pl --suite=smartengine_consistent_snapshot  --nowarnings --retry=3  --parallel=6 --force --report-unstable-tests \
              --initialize="--serverless=true" \
              --initialize="--objectstore_provider=local" \
              --skip-test-list=collections/disabled-smartengine-serverless.def
          ./mysql-test-run.pl --suite=smartengine  --nowarnings --retry=3  --parallel=6 --force --report-unstable-tests \
              --initialize="--serverless=true" \
              --initialize="--objectstore_provider=local" \
              --initialize="--consistent_snapshot_smartengine_tar_mode=TAR" \
              --initialize="--consistent_snapshot_innodb_tar_mode=TAR" \
              --skip-test-list=collections/disabled-smartengine-serverless.def

      - name: view logs of mtr serverless
        if: ${{ failure() }}
        run: |
          for logfile in $( ls bu/mysql-test/var/*/log/*.err ); do
              echo "logfile:"$logfile
              cat $logfile
          done

      - name: run mtr on normal file
        run: |
          cd bu
          cd mysql-test
          ./mysql-test-run.pl --suite=consensus_replication  --nowarnings --retry=3  --parallel=6 --force --report-unstable-tests --initialize="--serverless=false"
          ./mysql-test-run.pl --suite=smartengine --nowarnings --retry=3  --parallel=6 --force --report-unstable-tests --initialize="--serverless=false"

      - name: view logs of mtr on normal file
        if: ${{ failure() }}
        run: |
          for logfile in $( ls bu/mysql-test/var/*/log/*.err ); do
              echo "logfile:"$logfile
              cat $logfile
          done
