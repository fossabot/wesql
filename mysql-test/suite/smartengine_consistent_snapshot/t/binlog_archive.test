#
# Test for binlog archive to object store.
#
--echo # Binlog persist to object store

--let $MYSQLD_DATADIR=`select @@datadir`

--echo # Server restart with --serverless=true --binlog_archive_expire_auto_purge=false
--let $restart_parameters=restart: --smartengine=1 --default-storage-engine=smartengine --serverless=true --binlog_archive_expire_auto_purge=false
--source include/restart_mysqld.inc

CREATE DATABASE db1;
CREATE TABLE t1(c1 int) ENGINE=SMARTENGINE ;
INSERT INTO t1 values(1);
INSERT INTO t1 values(2);

FLUSH logs;

INSERT INTO t1 values(3);

FLUSH logs;

INSERT INTO t1 values(4);

FLUSH logs;

SELECT * FROM t1;
SHOW CREATE TABLE t1;

--source include/show_binary_logs.inc

sleep 1;

SELECT Log_name from INFORMATION_SCHEMA.BINLOG_PERSISTENT_FILE_INDEX;
--disable_warnings
SELECT SUBSTRING_INDEX(REPLACE(Log_name, '/', ' '),  ' ', -1) as log_slice from INFORMATION_SCHEMA.BINLOG_PERSISTENT_FILES order by log_slice;
--enable_warnings

--disable_warnings
--let logfile = query_get_value(SELECT Log_name from INFORMATION_SCHEMA.BINLOG_PERSISTENT_FILE_INDEX, Log_name, 2)
--enable_warnings
--echo # Puge persistent binlog $logfile
--eval SELECT binlog_persistent_purge('$logfile')

SELECT Log_name from INFORMATION_SCHEMA.BINLOG_PERSISTENT_FILE_INDEX;
--disable_warnings
SELECT SUBSTRING_INDEX(REPLACE(Log_name, '/', ' '),  ' ', -1) as log_slice from INFORMATION_SCHEMA.BINLOG_PERSISTENT_FILES order by log_slice;
--enable_warnings

DROP DATABASE db1;
