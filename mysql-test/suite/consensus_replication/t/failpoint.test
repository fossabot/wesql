#only run this case with cmake -DWITH_FAIL_POINT=ON

--source include/have_wesql_test.inc
--source include/paxos.inc

# connect 3 server. must have test database
--connect (conn1,127.0.0.1,root,,test,$MYPORT_1)
--connect (conn2,127.0.0.1,root,,test,$MYPORT_2)
--connect (conn3,127.0.0.1,root,,test,$MYPORT_3)

# wait leader and find who is leader
--connection conn1
--let $isleader=`select server_id from information_schema.wesql_cluster_local where role='leader'`
if ($isleader)
{
  --let $leader= $isleader
}

--connection conn2
--let $isleader=`select server_id from information_schema.wesql_cluster_local where role='leader'`
if ($isleader)
{
  --let $leader= $isleader
}

--connection conn3
--let $isleader=`select server_id from information_schema.wesql_cluster_local where role='leader'`
if ($isleader)
{
  --let $leader= $isleader
}

# test leader transfer
if ($leader == 1) 
{
  --connection conn1
}
if ($leader == 2) 
{
  --connection conn2
}
if ($leader == 3) 
{
  --connection conn3
}

#change consensus_leader to 1;
--replace_result $PAXOS_PORT_1 PAXOS_PORT_1
eval call dbms_consensus.change_leader("127.0.0.1:$PAXOS_PORT_1");
--connection conn1
--enable_reconnect
let $wait_condition= select count(*)=1 from information_schema.wesql_cluster_local where role='leader';
--source include/wait_condition.inc
select server_id, role from information_schema.wesql_cluster_local;

# parameters: 1.failpoint name. 2. execution type, see FailPointType. 3. execution times, only for FailPoint::finiteTimes
#             4.FailPointData type, some failpoint needs some input. see FailPointData. 5. the FailPointData
#              6. propability, only for FailPoint::random
eval call dbms_consensus.activate_failpoint("LeaderTransferFail", 1, 0, 0, "0", 0.0);

# transfer to 2, will fail
--replace_result $PAXOS_PORT_2 PAXOS_PORT_2
eval call dbms_consensus.change_leader("127.0.0.1:$PAXOS_PORT_2");

--sleep 2
# conn1 still leader 
select server_id, role from information_schema.wesql_cluster_local;

eval call dbms_consensus.deactivate_failpoint("LeaderTransferFail");

# transfer to 2, will success
--replace_result $PAXOS_PORT_2 PAXOS_PORT_2
eval call dbms_consensus.change_leader("127.0.0.1:$PAXOS_PORT_2");

# conn1 now follower 
--sleep 1
select server_id, role from information_schema.wesql_cluster_local;

--connection conn2
--enable_reconnect
let $wait_condition= select count(*)=1 from information_schema.wesql_cluster_local where role='leader';
--source include/wait_condition.inc
select server_id, role from information_schema.wesql_cluster_local;

--replace_result $PAXOS_PORT_1 PAXOS_PORT_1
eval call dbms_consensus.change_leader("127.0.0.1:$PAXOS_PORT_1");

