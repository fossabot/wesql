Test adding unique index inplace(rebuild) in a table with primary key
###################################################################
# ref https://yuque.antfin-inc.com/db_core_team/internal_docs/wywa0h#f68c70b7
# t0: create table time
# t1: build-sk start time
# t2: build-base sk finish, and uk check start
# t3: uk-check finish
# d1: data in [t0-t1]
# d2: data in [t1-t2]
# d3: data in [t2-t3]
# d4: data in [t3-]
###################################################################
# Using two connections for following tests, now establish connection con1 (user=root)
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with latin1 and latin1_bin
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE latin1_bin DEFAULT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET latin1 COLLATE latin1_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE latin1_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=latin1 COLLATE=latin1_bin
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with gbk and gbk_bin
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE gbk_bin DEFAULT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE gbk_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk COLLATE=gbk_bin
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with gbk and gbk_chinese_ci
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET gbk COLLATE gbk_chinese_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=gbk
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with utf8 and utf8_bin
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_bin;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_bin' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb3_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_bin
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with utf8 and utf8_general_ci
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8 COLLATE utf8_general_ci;
Warnings:
Warning	3719	'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.
Warning	3778	'utf8mb3_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb3
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with utf8mb4 and utf8mb4_bin
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_bin;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_bin DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with utf8mb4 and utf8mb4_general_ci
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) COLLATE utf8mb4_general_ci DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
drop table t1;
# Test suite/smartengine/t/online_ddl_add_uk_with_pk_char_rebuild.inc with utf8mb4 and utf8mb4_0900_ai_ci
###################################################################
# case 1: key1 in d1 duplicates with key2 in d1
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
INSERT INTO t1 values(1, '1');
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 1.2: key1 in d1 duplicates with key2 in d1, but with a deletion
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
INSERT INTO t1 values(1, '1');
DELETE FROM t1 WHERE b='1';
INSERT INTO t1 values(2, '1');
alter table t1 add index t1_b(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
Add unique index successfully
select * from t1;
a	c	b
2	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`),
  KEY `t1_b` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 2.1: key1 in d1 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 2.2: key1 in d1 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b=1 WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 2.3: key1 in d1 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 2.4: key1 in d1 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b=1;
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry 'NULL' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 2.5: key1 in d1 duplicates with multiple delete-insert on key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(3, '1');
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 3.1: key1 in d1 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 3.2: key1 in d1 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 3.3: key1 in d1 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 3.4: key1 in d1 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry 'NULL' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 4.1: key1 in d1 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
select * from t1;
a	b
1	1
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
5	1
failed to add unique index
select * from t1;
a	b
1	1
5	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 4.2: key1 in d1 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
UPDATE t1 SET b='1' WHERE a=2;
select * from t1;
a	b
1	1
2	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	1
failed to add unique index
select * from t1;
a	b
1	1
2	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 4.3: key1 in d1 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
delete from t1 where b='1';
insert into t1 values(5, '1');
select * from t1;
a	b
5	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
5	NULL	1
add unique index successfully
select * from t1;
a	c	b
5	NULL	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 4.4: key1 in d1 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '1');
delete from t1 where b='1';
select * from t1;
a	b
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '1' for key 't1.t1_ub'
select * from t1;
a	b
failed to add unique index
select * from t1;
a	b
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 5.1: key1 in d2 duplicates with inserted key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
4	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
4	2
5	2
failed to add unique index
select * from t1;
a	b
1	1
4	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 5.2: key1 in d2 duplicates with updated key2 in d2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(5, '2');
UPDATE t1 SET b='2' WHERE a=1;
select * from t1;
a	b
1	2
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
5	2
failed to add unique index
select * from t1;
a	b
1	2
5	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 5.3: key1 in d2 duplicates with inserted key2 in d2 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
delete from t1 where b='2';
insert into t1 values(5, '2');
select * from t1;
a	b
1	1
5	2
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
5	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 5.4: key1 in d2 duplicates with inserted key2 in d2 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin SIGNAL start_dml WAIT_FOR dml_done';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR start_dml';
insert into t1 values(4, '2');
insert into t1 values(5, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_done';
# Switch to connection default
ERROR 23000: Duplicate entry 'NULL' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 6.1: key1 in d2 duplicates with inserted key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 6.2: key1 in d2 duplicates with updated key2 in d3
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 6.3: key1 in d2 duplicates with inserted key2 in d3 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 6.4: key1 in d2 duplicates with inserted key2 in d3 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry 'NULL' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 7.1: key1 in d2 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 7.2: key1 in d2 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 7.3: key1 in d2 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 7.4: key1 in d2 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_scan_base_begin        SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 8.1: key1 in d3 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 8.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 8.3: key1 in d3 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 8.4: key1 in d3 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_begin SIGNAL dml1 WAIT_FOR dml1_end';
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml2 WAIT_FOR dml2_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml1';
insert into t1 values(2, '2');
SET DEBUG_SYNC= 'now SIGNAL dml1_end';
SET DEBUG_SYNC= 'now WAIT_FOR dml2';
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml2_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 9.1: key1 in d4 duplicates with inserted key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
2	2
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
2	2
3	2
failed to add unique index
select * from t1;
a	b
1	1
2	2
3	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 9.2: key1 in d3 duplicates with updated key2 in d4
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
update t1 set b='2' where a=1;
select * from t1;
a	b
1	2
2	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	2
2	2
failed to add unique index
select * from t1;
a	b
1	2
2	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 9.3: key1 in d4 duplicates with inserted key2 in d4 but with a deletion before inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
delete from t1 where b='2';
insert into t1 values(3, '2');
select * from t1;
a	b
1	1
3	2
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
add unique index successfully
select * from t1;
a	c	b
1	NULL	1
3	NULL	2
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `c` char(10) DEFAULT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `t1_ub` (`b`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
###################################################################
# case 9.4: key1 in d4 duplicates with inserted key2 in d4 but with a deletion after inserting key2
###################################################################
CREATE TABLE t1 (a INT primary key, b char(10))CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
insert into t1 values(1, '1');
SET DEBUG_SYNC= 'se.inplace_create_sk_check_constraint_done  SIGNAL dml WAIT_FOR dml_end';
alter table t1 add column c char(10) after a, add unique index t1_ub(b), ALGORITHM=INPLACE, LOCK=DEFAULT;
# Switch to connection con1
SET DEBUG_SYNC= 'now WAIT_FOR dml';
insert into t1 values(2, '2');
insert into t1 values(3, '2');
delete from t1 where b='2';
select * from t1;
a	b
1	1
SET DEBUG_SYNC= 'now SIGNAL dml_end';
# Switch to connection default
ERROR 23000: Duplicate entry '2' for key 't1.t1_ub'
select * from t1;
a	b
1	1
failed to add unique index
select * from t1;
a	b
1	1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int NOT NULL,
  `b` char(10) DEFAULT NULL,
  PRIMARY KEY (`a`)
) ENGINE=SMARTENGINE DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1;
